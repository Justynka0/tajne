import React, { useState, useEffect } from 'react';
import { Upload, Download, AlertCircle, CheckCircle, Loader, Package, Settings } from 'lucide-react';

const AdminSystem = () => {
  const [currentConfig, setCurrentConfig] = useState(null);
  const [latestVersion, setLatestVersion] = useState('');
  const [minVersion, setMinVersion] = useState('');
  const [downloadUrl, setDownloadUrl] = useState('');
  const [selectedFile, setSelectedFile] = useState(null);
  const [status, setStatus] = useState({ message: '', type: '' });
  const [isLoading, setIsLoading] = useState(false);
  const [activeTab, setActiveTab] = useState('config');

  // Za≈Çaduj aktualnƒÖ konfiguracjƒô
  useEffect(() => {
    loadCurrentConfig();
  }, []);

  const loadCurrentConfig = async () => {
    try {
      const response = await fetch('/version.json');
      const data = await response.json();
      setCurrentConfig(data);
      setLatestVersion(data.latest_version);
      setMinVersion(data.min_required_version);
      setDownloadUrl(data.download_url || '');
    } catch (error) {
      showStatus('Nie mo≈ºna za≈Çadowaƒá aktualnej konfiguracji', 'error');
    }
  };

  const showStatus = (message, type) => {
    setStatus({ message, type });
    setTimeout(() => setStatus({ message: '', type: '' }), 5000);
  };

  const isValidVersion = (version) => {
    return /^\d+\.\d+\.\d+(-[a-zA-Z0-9]+)?$/.test(version);
  };

  // Zapisz konfiguracjƒô (version.json)
  const saveConfiguration = async () => {
    if (!isValidVersion(latestVersion)) {
      showStatus('‚ùå Nieprawid≈Çowy format wersji (u≈ºyj: 1.0.0 lub 1.0.0-beta)', 'error');
      return;
    }

    if (!isValidVersion(minVersion)) {
      showStatus('‚ùå Nieprawid≈Çowy format minimalnej wersji', 'error');
      return;
    }

    setIsLoading(true);

    const newConfig = {
      latest_version: latestVersion,
      min_required_version: minVersion,
      download_url: downloadUrl || `${window.location.origin}/nextbus.apk`,
      last_updated: new Date().toISOString()
    };

    try {
      // W prawdziwym ≈õrodowisku to by wywo≈Ça≈Ço Netlify Function
      // kt√≥ra zapisuje plik na serwerze
      const response = await fetch('/.netlify/functions/update-version', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(newConfig)
      });

      if (response.ok) {
        setCurrentConfig(newConfig);
        showStatus('‚úÖ Konfiguracja zapisana pomy≈õlnie!', 'success');
        
        // Pobierz plik jako backup
        const blob = new Blob([JSON.stringify(newConfig, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'version.json';
        link.click();
        URL.revokeObjectURL(url);
      } else {
        throw new Error('B≈ÇƒÖd zapisu');
      }
    } catch (error) {
      showStatus('‚ö†Ô∏è Symulacja: JSON wygenerowany (pobierz i wgraj rƒôcznie)', 'error');
      
      // Fallback - pobierz plik
      const blob = new Blob([JSON.stringify(newConfig, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'version.json';
      link.click();
      URL.revokeObjectURL(url);
    } finally {
      setIsLoading(false);
    }
  };

  // Upload APK
  const handleFileSelect = (event) => {
    const file = event.target.files[0];
    if (file && file.name.endsWith('.apk')) {
      setSelectedFile(file);
      showStatus(`üì¶ Wybrano: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`, 'success');
    } else {
      showStatus('‚ùå Wybierz prawid≈Çowy plik APK', 'error');
      setSelectedFile(null);
    }
  };

  const uploadAPK = async () => {
    if (!selectedFile) {
      showStatus('‚ùå Najpierw wybierz plik APK', 'error');
      return;
    }

    setIsLoading(true);

    try {
      const formData = new FormData();
      formData.append('apk', selectedFile);
      formData.append('version', latestVersion);

      // W prawdziwym ≈õrodowisku - upload do Netlify
      const response = await fetch('/.netlify/functions/upload-apk', {
        method: 'POST',
        body: formData
      });

      if (response.ok) {
        showStatus('‚úÖ APK wgrane pomy≈õlnie! Stara wersja zosta≈Ça usuniƒôta.', 'success');
        setSelectedFile(null);
        
        // Automatycznie zaktualizuj version.json
        await saveConfiguration();
      } else {
        throw new Error('Upload failed');
      }
    } catch (error) {
      showStatus('‚ö†Ô∏è Symulacja uploadu - w produkcji u≈ºyj Netlify Functions', 'error');
      console.log('Plik do wgrania:', selectedFile.name, selectedFile.size);
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 text-white p-4 md:p-8">
      <div className="max-w-4xl mx-auto">
        {/* Header */}
        <div className="text-center mb-8">
          <div className="w-20 h-20 bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl mx-auto mb-4 flex items-center justify-center shadow-lg shadow-blue-500/50">
            <Settings className="w-10 h-10" />
          </div>
          <h1 className="text-4xl font-bold bg-gradient-to-r from-blue-400 to-blue-600 bg-clip-text text-transparent mb-2">
            Panel Administracyjny
          </h1>
          <p className="text-gray-400">ZarzƒÖdzaj aktualizacjami aplikacji NextBus</p>
        </div>

        {/* Current Version Card */}
        {currentConfig && (
          <div className="bg-blue-500/10 border border-blue-500/30 rounded-xl p-4 mb-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-gray-400 text-sm mb-1">Aktualna wersja w systemie</p>
                <p className="text-3xl font-bold text-blue-400">{currentConfig.latest_version}</p>
              </div>
              <Package className="w-12 h-12 text-blue-400 opacity-50" />
            </div>
            {currentConfig.last_updated && (
              <p className="text-xs text-gray-500 mt-2">
                Ostatnia aktualizacja: {new Date(currentConfig.last_updated).toLocaleString('pl-PL')}
              </p>
            )}
          </div>
        )}

        {/* Tabs */}
        <div className="flex gap-2 mb-6">
          <button
            onClick={() => setActiveTab('config')}
            className={`flex-1 py-3 px-4 rounded-lg font-semibold transition-all ${
              activeTab === 'config'
                ? 'bg-blue-500 text-white shadow-lg shadow-blue-500/50'
                : 'bg-white/5 text-gray-400 hover:bg-white/10'
            }`}
          >
            ‚öôÔ∏è Konfiguracja
          </button>
          <button
            onClick={() => setActiveTab('upload')}
            className={`flex-1 py-3 px-4 rounded-lg font-semibold transition-all ${
              activeTab === 'upload'
                ? 'bg-blue-500 text-white shadow-lg shadow-blue-500/50'
                : 'bg-white/5 text-gray-400 hover:bg-white/10'
            }`}
          >
            üì¶ Upload APK
          </button>
        </div>

        {/* Main Card */}
        <div className="bg-white/5 backdrop-blur-sm border border-white/10 rounded-2xl p-6 shadow-2xl">
          {activeTab === 'config' ? (
            // Configuration Tab
            <div className="space-y-6">
              <div>
                <label className="block text-sm font-semibold mb-2 text-gray-300">
                  üî¢ Najnowsza wersja
                </label>
                <input
                  type="text"
                  value={latestVersion}
                  onChange={(e) => setLatestVersion(e.target.value)}
                  placeholder="1.0.0"
                  className="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-white placeholder-gray-500 focus:outline-none focus:border-blue-500 focus:bg-blue-500/10 transition-all"
                />
              </div>

              <div>
                <label className="block text-sm font-semibold mb-2 text-gray-300">
                  ‚ö†Ô∏è Minimalna wymagana wersja
                </label>
                <input
                  type="text"
                  value={minVersion}
                  onChange={(e) => setMinVersion(e.target.value)}
                  placeholder="1.0.0"
                  className="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-white placeholder-gray-500 focus:outline-none focus:border-blue-500 focus:bg-blue-500/10 transition-all"
                />
              </div>

              <div>
                <label className="block text-sm font-semibold mb-2 text-gray-300">
                  üîó Link do pobrania (opcjonalnie)
                </label>
                <input
                  type="text"
                  value={downloadUrl}
                  onChange={(e) => setDownloadUrl(e.target.value)}
                  placeholder="https://nextbus.netlify.app/nextbus.apk"
                  className="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-white placeholder-gray-500 focus:outline-none focus:border-blue-500 focus:bg-blue-500/10 transition-all"
                />
              </div>

              <button
                onClick={saveConfiguration}
                disabled={isLoading}
                className="w-full bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-semibold py-3 rounded-xl transition-all transform hover:scale-[1.02] active:scale-100 shadow-lg shadow-blue-500/50 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
              >
                {isLoading ? (
                  <>
                    <Loader className="w-5 h-5 animate-spin" />
                    Zapisywanie...
                  </>
                ) : (
                  <>
                    <CheckCircle className="w-5 h-5" />
                    Zapisz konfiguracjƒô
                  </>
                )}
              </button>
            </div>
          ) : (
            // Upload Tab
            <div className="space-y-6">
              <div>
                <label className="block text-sm font-semibold mb-3 text-gray-300">
                  üì¶ Wybierz plik APK
                </label>
                <div className="relative">
                  <input
                    type="file"
                    accept=".apk"
                    onChange={handleFileSelect}
                    className="w-full bg-white/5 border-2 border-dashed border-white/20 rounded-xl px-4 py-8 text-white cursor-pointer hover:border-blue-500 hover:bg-blue-500/10 transition-all file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-500 file:text-white hover:file:bg-blue-600 file:cursor-pointer"
                  />
                </div>
                {selectedFile && (
                  <div className="mt-3 bg-white/5 rounded-lg p-3 flex items-center gap-3">
                    <Package className="w-5 h-5 text-blue-400" />
                    <div className="flex-1">
                      <p className="text-sm font-semibold text-white">{selectedFile.name}</p>
                      <p className="text-xs text-gray-400">
                        {(selectedFile.size / 1024 / 1024).toFixed(2)} MB
                      </p>
                    </div>
                  </div>
                )}
              </div>

              <button
                onClick={uploadAPK}
                disabled={isLoading || !selectedFile}
                className="w-full bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-semibold py-3 rounded-xl transition-all transform hover:scale-[1.02] active:scale-100 shadow-lg shadow-green-500/50 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
              >
                {isLoading ? (
                  <>
                    <Loader className="w-5 h-5 animate-spin" />
                    Wgrywanie...
                  </>
                ) : (
                  <>
                    <Upload className="w-5 h-5" />
                    Wgraj APK (auto-update version.json)
                  </>
                )}
              </button>

              <div className="bg-yellow-500/10 border border-yellow-500/30 rounded-xl p-4">
                <div className="flex gap-3">
                  <AlertCircle className="w-5 h-5 text-yellow-400 flex-shrink-0 mt-0.5" />
                  <div className="text-sm text-yellow-200">
                    <p className="font-semibold mb-1">Jak to dzia≈Ça:</p>
                    <ul className="space-y-1 text-yellow-300/80">
                      <li>1. Wybierasz plik APK i wgrywasz</li>
                      <li>2. System zapisuje go jako <code className="bg-yellow-500/20 px-1 rounded">nextbus.apk</code></li>
                      <li>3. Stara wersja zostaje automatycznie usuniƒôta</li>
                      <li>4. Plik <code className="bg-yellow-500/20 px-1 rounded">version.json</code> aktualizuje siƒô sam</li>
                      <li>5. U≈ºytkownicy pobierajƒÖ zawsze najnowszƒÖ wersjƒô</li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Status Message */}
          {status.message && (
            <div
              className={`mt-6 p-4 rounded-xl flex items-center gap-3 animate-in slide-in-from-top ${
                status.type === 'success'
                  ? 'bg-green-500/10 border border-green-500/30 text-green-300'
                  : 'bg-red-500/10 border border-red-500/30 text-red-300'
              }`}
            >
              {status.type === 'success' ? (
                <CheckCircle className="w-5 h-5 flex-shrink-0" />
              ) : (
                <AlertCircle className="w-5 h-5 flex-shrink-0" />
              )}
              <p className="text-sm font-medium">{status.message}</p>
            </div>
          )}
        </div>

        {/* Info Box */}
        <div className="mt-6 bg-blue-500/10 border border-blue-500/30 rounded-xl p-4">
          <h3 className="font-semibold text-blue-300 mb-2 flex items-center gap-2">
            <Download className="w-5 h-5" />
            Strona pobierania dla u≈ºytkownik√≥w
          </h3>
          <p className="text-sm text-blue-200 mb-3">
            U≈ºytkownicy wchodzƒÖ na <code className="bg-blue-500/20 px-2 py-1 rounded">yoursite.com/download</code> i automatycznie pobierajƒÖ najnowszy APK
          </p>
          <a
            href="/download"
            target="_blank"
            rel="noopener noreferrer"
            className="inline-flex items-center gap-2 text-sm text-blue-400 hover:text-blue-300 transition-colors"
          >
            PodglƒÖd strony pobierania ‚Üí
          </a>
        </div>
      </div>
    </div>
  );
};

export default AdminSystem;
